#!/usr/bin/env bash

set -e
set -u
set -o pipefail

###################################################################################################
###################################################################################################
###
### GLOBAL VARIABLES
###
###################################################################################################
###################################################################################################

### The following env variables are set inside the Dockerfiles
###   MY_USER
###   MY_GROUP
###   TOMCAT_START
###   TOMCAT_RELOAD

###
### Path to scripts to source
###
ENTRYPOINT_DIR="/docker-entrypoint.d" # All entrypoint scripts

###################################################################################################
###################################################################################################
###
### INCLUDES
###
###################################################################################################
###################################################################################################

###
### Bootstrap
###
# shellcheck disable=SC1090,SC1091
. "${ENTRYPOINT_DIR}/bootstrap/bootstrap.sh"

###
### Source available entrypoint scripts
###
# shellcheck disable=SC2012
for f in $(ls -1 "${ENTRYPOINT_DIR}/"*.sh | sort -u); do
	# shellcheck disable=SC1090
	. "${f}"
done

###################################################################################################
###################################################################################################
###
### MAIN ENTRYPOINT
###
###################################################################################################
###################################################################################################

# -------------------------------------------------------------------------------------------------
# SET ENVIRONMENT VARIABLES AND DEFAULT VALUES
# -------------------------------------------------------------------------------------------------

###
### Show Debug level
###
log "info" "Entrypoint debug: $(env_get "DEBUG_ENTRYPOINT")"
log "info" "Runtime debug: $(env_get "DEBUG_RUNTIME")"

###
### Show environment vars
###
log "info" "-------------------------------------------------------------------------"
log "info" "Environment Variables (set/default)"
log "info" "-------------------------------------------------------------------------"

log "info" "Variables: General:"
env_var_export "NEW_UID" 1000
env_var_export "NEW_GID" 1000
env_var_export "TIMEZONE" "UTC"
env_var_export "DOCKER_LOGS" "1"

# -------------------------------------------------------------------------------------------------
# VERIFY ENVIRONMENT VARIABLES
# -------------------------------------------------------------------------------------------------

log "info" "-------------------------------------------------------------------------"
log "info" "Validate Settings"
log "info" "-------------------------------------------------------------------------"

log "info" "Settings: General:"
env_var_validate "NEW_UID"
env_var_validate "NEW_GID"
env_var_validate "TIMEZONE"
env_var_validate "DOCKER_LOGS"

# -------------------------------------------------------------------------------------------------
# APPLY SETTINGS
# -------------------------------------------------------------------------------------------------

log "info" "-------------------------------------------------------------------------"
log "info" "Apply Settings"
log "info" "-------------------------------------------------------------------------"

###
### Change uid/gid
###
set_uid "${NEW_UID}" "${MY_USER}"
set_gid "${NEW_GID}" "${MY_USER}" "${MY_GROUP}"

###
### Set timezone
###
set_timezone "${TIMEZONE}"

###
### Fix directory/file permissions (in case it is mounted)
###
fix_perm "/usr/local/tomcat" "1"
fix_perm "/data/webroot/default" "0"

# -------------------------------------------------------------------------------------------------
# MAIN ENTRYPOINT
# -------------------------------------------------------------------------------------------------

# shellcheck disable=SC2153
_TOMCAT_VERSION="$(eval "${TOMCAT_VERSION}" || true)" # Set via Dockerfile

log "info" "-------------------------------------------------------------------------"
log "info" "Main Entrypoint"
log "info" "-------------------------------------------------------------------------"

log "done" "Starting Tomcat: ${_TOMCAT_VERSION}"

exec "$@"
